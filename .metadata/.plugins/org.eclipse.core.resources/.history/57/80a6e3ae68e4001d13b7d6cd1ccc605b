<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@page import="net.etfbl.dto.User"%>
<%@page import="net.etfbl.beans.UserBean"%>
<%@page import="java.util.List"%>
<%@page import="java.util.Map"%>
<%@page import="net.etfbl.mq.Message"%>
<%@page import="java.time.format.DateTimeFormatter"%>
<jsp:useBean id="userBean" type="net.etfbl.beans.UserBean"
	scope="session" />
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="styles/style.css" type="text/css" rel="stylesheet">
<title>Messaging App</title>
<script>
    function refreshMessages() {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                let messages = JSON.parse(xhr.responseText);
                let messagesElement = document.querySelector(".messages");
                messagesElement.innerHTML = "";

                for (let message of messages) {
                    let messageElement = document.createElement("div");
                    messageElement.className = "message sent";
                    messageElement.innerHTML = `<p class="message-text">${message.messageText}</p>`;
                    messagesElement.appendChild(messageElement);
                }
            }
        };

        xhr.open("GET", "Controller?action=refreshMessages", true);
        xhr.send();
    }

    setInterval(refreshMessages, 2000); // Poll every 2 seconds
</script>

</head>
<body>
	<h1>ETF Anonymous Messaging App</h1>
	<a href="?action=logout">Odjava sa sistema</a>
	<hr />
	<div class="container">
		<div class="users-list">
			<h2>Users</h2>
			<ul>
				<%
				for (User user : userBean.getAll()) {
				%>
				<li><a
					href="?action=recipientSelected&recipientId=<%=user.getId()%>"><%=user.getUsername()%></a></li>
				<%
				}
				%>
			</ul>
		</div>
		<div class="chat-area">
			<h2>Chat</h2>
			<div class="messages">
				<%
				Map<Integer, List<Message>> recipientMessages = (Map<Integer, List<Message>>) request.getSession()
						.getAttribute("recipientMessages");
				if (recipientMessages != null && userBean != null && userBean.getRecipient() != null) {
					List<Message> sentMessages = recipientMessages.get(userBean.getRecipient().getId());
					if (sentMessages != null) {
						for (Message message : sentMessages) {
				%>
				<div class="message sent">
					<p class="sender-info"><%=message.getSenderUsername()%>
						<span class="time-sent"><%=message.getTimeSent().format(DateTimeFormatter.ofPattern("HH:mm"))%></span>
					</p>
					<p class="message-text"><%=message.getMessageText()%></p>
				</div>
				<%
				}
				}
				}
				%>
			</div>

			<div class="input-section">
				<form action="?action=sendMessage" method="post">
					<input type="text" name="message"
						placeholder="Type your message..." style="width: 100%;">
					<button type="submit">Send</button>
				</form>
			</div>
		</div>
	</div>
</body>
</html>
